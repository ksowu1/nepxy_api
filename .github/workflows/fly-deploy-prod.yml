name: Deploy Prod

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy"
        required: true
        default: "main"
      app_name:
        description: "Fly app name"
        required: true
        default: "nepxy-prod"
      base_url:
        description: "Base URL for health check"
        required: true
        default: "https://nepxy-prod.fly.dev"
      confirm:
        description: "Type DEPLOY to confirm"
        required: true
        default: ""

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Confirm deploy intent
        run: |
          if [ "${{ inputs.confirm }}" != "DEPLOY" ]; then
            echo "Confirmation missing. Set confirm=DEPLOY to proceed." >&2
            exit 1
          fi

      - name: Check latest staging canary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'PY'
          import json
          import os
          import sys
          import urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ.get("GITHUB_TOKEN")
          if not token:
            print("Missing GITHUB_TOKEN for canary check.", file=sys.stderr)
            sys.exit(1)
          url = f"https://api.github.com/repos/{repo}/actions/workflows/nightly-canary-staging.yml/runs?branch=main&per_page=1"
          req = urllib.request.Request(
              url,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
              },
          )
          with urllib.request.urlopen(req) as resp:
            data = json.load(resp)
          runs = data.get("workflow_runs") or []
          if not runs:
            print("No staging canary runs found.", file=sys.stderr)
            sys.exit(1)
          run = runs[0]
          status = run.get("status")
          conclusion = run.get("conclusion")
          print(f"Latest staging canary: status={status} conclusion={conclusion}")
          if conclusion != "success":
            sys.exit(1)
          PY

  deploy:
    runs-on: ubuntu-latest
    needs: [ guard ]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy to Fly (prod)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          fly deploy --app "${{ inputs.app_name }}" --remote-only

      - name: Wait for health
        run: |
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "${{ inputs.base_url }}/health" || true)
            if [ "$code" = "200" ]; then
              echo "Health check OK"
              exit 0
            fi
            sleep 2
          done
          echo "Health check failed" >&2
          exit 1
